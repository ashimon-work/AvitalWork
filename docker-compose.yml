services:
  # PostgreSQL Database Service
  db:
    image: postgres:15
    container_name: magic_store_db_prod
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-magic_store_prod} # Consider using different DB name for prod
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD} # Use environment variable for password in prod
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data # Use a separate volume for prod data
    restart: unless-stopped
    networks:
      - internal_network

  # Backend API Service (NestJS)
  api:
    container_name: magic_store_api_prod
    build:
      context: . # Context is the monorepo root
      dockerfile: backend/api/Dockerfile.prod # Path to Dockerfile relative to context
    environment:
      NODE_ENV: production
      PORT: 3000 # NestJS listens on this port internally
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD} # Use environment variable
      POSTGRES_DB: ${POSTGRES_DB:-magic_store_prod}
      JWT_SECRET: ${JWT_SECRET}, # Pass JWT_SECRET from .env file,
      env_file: .env
      WHATSAPP_ACCESS_TOKEN: ${WHATSAPP_ACCESS_TOKEN}
    depends_on:
      - db
    restart: unless-stopped
    networks:
      - internal_network
      - web_network # Connect to the network Nginx is on

  # Storefront Frontend Service (Nginx serving Angular build)
  # Nginx service serving both frontends based on hostname
  frontend:
    container_name: magic_store_nginx_prod
    build:
      context: . # Build context is the monorepo root
      dockerfile: docker/nginx/Dockerfile.prod # Use the multi-stage Nginx Dockerfile
    ports:
      - "80:80" # Expose Nginx port 80 to the host
    volumes:
      # Mount the custom Nginx configuration
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro # Mount to the main nginx.conf path
    depends_on:
      - api # Ensure API is ready before frontend tries to proxy to it
    restart: unless-stopped
    networks:
      - web_network # Connect to the network Nginx is on

# Define Networks
networks:
  internal_network: # For communication between api and db
    driver: bridge
  web_network:      # For communication between frontend (Nginx) and api, and external access
    driver: bridge

# Named Volumes Definition
volumes:
  postgres_data_prod: # Separate volume for production database