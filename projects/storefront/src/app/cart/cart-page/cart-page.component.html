<div class="cart-page-container" *ngIf="cartState$ | async as cartState; else loadingCart">
  <h1>Shopping Cart</h1>

  <ng-container *ngIf="cartState.items.length > 0; else emptyCart">
    <div class="cart-layout">
      <!-- Left Section: Cart Items -->
      <div class="cart-items-section">
        <table>
          <thead>
            <tr>
              <th colspan="2">Product</th>
              <th>Price</th>
              <th>Quantity</th>
              <th>Subtotal</th>
              <th></th> <!-- For remove button -->
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of cartState.items" class="cart-item">
              <td class="item-image">
                <a [routerLink]="['/', currentStoreSlug$ | async, 'product', item.product.id]">
                  <img [src]="item.product.imageUrls[0] || '/assets/images/placeholder.png'" [alt]="item.product.name">
                </a>
              </td>
              <td class="item-details">
                <a [routerLink]="['/', currentStoreSlug$ | async, 'product', item.product.id]" class="item-name">{{ item.product.name }}</a>
                <!-- Display selected variants later if applicable -->
              </td>
              <td class="item-price">{{ item.product.price | currency }}</td>
              <td class="item-quantity">
                <!-- Basic quantity input - enhance later -->
                <input type="number"
                       [ngModel]="item.quantity"
                       (ngModelChange)="updateQuantity(item, $event.toString())"
                       min="1"
                       step="1">
              </td>
              <td class="item-subtotal">{{ calculateItemSubtotal(item) | currency }}</td>
              <td class="item-remove">
                <button (click)="removeItem(item)" title="Remove Item">&times;</button> <!-- Simple remove button -->
              </td>
            </tr>
          </tbody>
        </table>
        <div class="cart-actions-lower">
          <button class="continue-shopping-btn" (click)="goBack()">Continue Shopping</button>
          <button class="update-cart-btn" (click)="updateCart()">Update Cart</button> <!-- Might not be needed if quantity updates automatically -->
        </div>
      </div>

      <!-- Right Section: Order Summary -->
      <aside class="order-summary-section">
        <h2>Order Summary</h2>
        <div class="summary-row">
          <span>Subtotal:</span>
          <span>{{ calculateCartSubtotal(cartState.items) | currency }}</span>
        </div>
        <div class="summary-row">
          <span>Shipping:</span>
          <span>(Calculated at checkout)</span>
        </div>
        <div class="summary-row">
          <span>Taxes:</span>
          <span>(Calculated at checkout)</span>
        </div>
        <hr>
        <!-- Promo Code Section -->
        <div class="promo-code-section">
          <label for="promo-code-input">Promo Code:</label>
          <div class="promo-input-group">
            <input type="text" id="promo-code-input" placeholder="Enter promo code" [(ngModel)]="promoCode">
            <button (click)="applyPromoCode()" class="apply-promo-btn">Apply</button>
          </div>
          <div *ngIf="appliedPromoCodeDetails" class="promo-message"
               [ngClass]="{ 'success': appliedPromoCodeDetails.discountAmount > 0, 'error': appliedPromoCodeDetails.discountAmount === 0 && appliedPromoCodeDetails.message }">
            <p>{{ appliedPromoCodeDetails.message }}</p>
          </div>
        </div>

        <div class="summary-row" *ngIf="appliedPromoCodeDetails && appliedPromoCodeDetails.discountAmount > 0">
          <span>Discount ({{ appliedPromoCodeDetails.code }}):</span>
          <span>- {{ appliedPromoCodeDetails.discountAmount | currency }}</span>
        </div>
        <hr *ngIf="appliedPromoCodeDetails && appliedPromoCodeDetails.discountAmount > 0">

        <div class="summary-row total">
          <span>Total:</span>
          <span>{{ (calculateCartSubtotal(cartState.items) - (appliedPromoCodeDetails?.discountAmount || 0)) | currency }}</span>
        </div>
        <button class="checkout-btn bordered-button" (click)="proceedToCheckout()">Proceed to Checkout</button>
      </aside>
    </div>

    <!-- Recently Viewed Products Section -->
    <ng-container *ngIf="recentlyViewedProducts$ | async as recentlyViewed; else loadingRecentlyViewed">
      <div *ngIf="recentlyViewed.length > 0" class="recently-viewed-section">
        <h2>Recently Viewed Products</h2>
        <div class="product-grid">
          <app-product-card
            *ngFor="let product of recentlyViewed"
            [product]="product"
            [storeSlug]="currentStoreSlug$ | async">
          </app-product-card>
        </div>
      </div>
    </ng-container>
    <ng-template #loadingRecentlyViewed>
      <!-- Optional: loading indicator for recently viewed -->
    </ng-template>

  </ng-container>

  <ng-template #emptyCart>
    <div class="empty-cart-message">
      <p>Your shopping cart is empty.</p>
      <button [routerLink]="['/', currentStoreSlug$ | async]">Shop Now</button>
    </div>
  </ng-template>
</div>

<ng-template #loadingCart>
  <p>Loading cart...</p>
</ng-template>
