<!-- Main page container, styled to mimic Tailwind's bg-background and min-h-screen -->
<div class="page-wrapper" *ngIf="category$ | async as category; else loadingCategory">

  <!-- Inner container, mimics Tailwind's container mx-auto px-4 py-6 lg:px-6 lg:py-8 -->
  <div class="content-container">

    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb-nav animate-breadcrumb" aria-label="Breadcrumb navigation">
      <ol class="breadcrumb-list">
        <li class="breadcrumb-item">
          <a [routerLink]="[ (currentStoreSlug$ | async) ? '/' + (currentStoreSlug$ | async) : '/']" class="breadcrumb-link">{{ tKeys.SF_NAV_HOME | translate }}</a>
        </li>
        <li class="breadcrumb-separator">
          <img src="assets/icons/chevron-right.svg" alt="separator" class="icon icon-breadcrumb-separator">
        </li>
        <li class="breadcrumb-item">
          <span class="breadcrumb-page">{{ category.name }}</span>
        </li>
      </ol>
    </nav>

    <!-- Category Header -->
    <header class="category-title-header animate-category-header">
      <h1 class="category-name">{{ category.name }}</h1>
      <p class="category-description">{{ category.description }}</p>
    </header>

    <!-- Main Content Area (Flex Layout: Sidebar + Product Area) -->
    <div class="main-content-area">

      <!-- Sidebar Filters -->
      <aside class="filter-sidebar-wrapper animate-sidebar">
        <div class="filter-sidebar-content">
          <h2 class="filters-title">{{ tKeys.SF_CATEGORY_FILTERS_TITLE | translate }}</h2>

          <!-- Price Filter -->
          <div class="filter-group">
            <button class="filter-group-toggle" (click)="toggleFilterSection('price')">
              <h3 class="filter-group-title">{{ tKeys.SF_CATEGORY_FILTER_PRICE_RANGE | translate }}</h3>
              <img src="assets/icons/chevron-right.svg" alt="toggle price filter" class="icon icon-chevron" [class.is-open]="isFilterSectionOpen('price')">
            </button>
            <div class="filter-group-content" *ngIf="isFilterSectionOpen('price')">
              <!-- Replaced select with checkboxes for price ranges -->
              <div *ngFor="let priceRange of availablePriceRanges" class="filter-checkbox-item">
                <label class="custom-checkbox-label">
                  <input type="checkbox" class="native-checkbox-hidden" [(ngModel)]="selectedPriceRanges[priceRange.id]" (ngModelChange)="applyFilters()">
                  <span class="custom-checkbox-display">
                    <img src="assets/icons/check.svg" class="custom-checkbox-checkmark" *ngIf="selectedPriceRanges[priceRange.id]">
                  </span>
                  <span class="custom-checkbox-text">{{ (priceRange.labelTranslationKey | translate) || priceRange.id }}</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Tags Filter -->
          <div class="filter-group">
            <button class="filter-group-toggle" (click)="toggleFilterSection('tags')">
              <h3 class="filter-group-title">{{ tKeys.SF_CATEGORY_FILTER_TAGS | translate }}</h3>
              <img src="assets/icons/chevron-right.svg" alt="toggle tags filter" class="icon icon-chevron" [class.is-open]="isFilterSectionOpen('tags')">
            </button>
            <div class="filter-group-content" *ngIf="isFilterSectionOpen('tags')">
              <div *ngFor="let tag of availableTags" class="filter-checkbox-item">
                <label class="custom-checkbox-label">
                  <input type="checkbox" class="native-checkbox-hidden" [(ngModel)]="selectedTags[tag.value]" (ngModelChange)="applyFilters()">
                  <span class="custom-checkbox-display">
                    <img src="assets/icons/check.svg" class="custom-checkbox-checkmark" *ngIf="selectedTags[tag.value]">
                  </span>
                  <span class="custom-checkbox-text">{{ tag.translationKey | translate }}</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Colors Filter -->
          <div class="filter-group">
            <button class="filter-group-toggle" (click)="toggleFilterSection('colors')">
              <h3 class="filter-group-title">{{ tKeys.SF_CATEGORY_FILTER_COLORS | translate }}</h3>
              <img src="assets/icons/chevron-right.svg" alt="toggle colors filter" class="icon icon-chevron" [class.is-open]="isFilterSectionOpen('colors')">
            </button>
            <div class="filter-group-content" *ngIf="isFilterSectionOpen('colors')">
              <div *ngFor="let color of availableColors" class="filter-checkbox-item">
                <label class="custom-checkbox-label">
                  <input type="checkbox" class="native-checkbox-hidden" [(ngModel)]="selectedColors[color.value]" (ngModelChange)="applyFilters()">
                  <span class="custom-checkbox-display color-swatch-checkbox" [style.backgroundColor]="color.colorHex" [class.is-white]="color.value === 'White'">
                    <img src="assets/icons/check.svg" class="custom-checkbox-checkmark" *ngIf="selectedColors[color.value]" [class.checkmark-dark]="color.value !== 'Black'">
                  </span>
                  <span class="custom-checkbox-text">{{ color.translationKey | translate }}</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Sizes Filter -->
          <div class="filter-group">
            <button class="filter-group-toggle" (click)="toggleFilterSection('sizes')">
              <h3 class="filter-group-title">{{ tKeys.SF_CATEGORY_FILTER_SIZES | translate }}</h3>
              <img src="assets/icons/chevron-right.svg" alt="toggle sizes filter" class="icon icon-chevron" [class.is-open]="isFilterSectionOpen('sizes')">
            </button>
            <div class="filter-group-content" *ngIf="isFilterSectionOpen('sizes')">
              <div *ngFor="let size of availableSizes" class="filter-checkbox-item">
                <label class="custom-checkbox-label">
                  <input type="checkbox" class="native-checkbox-hidden" [(ngModel)]="selectedSizes[size.value]" (ngModelChange)="applyFilters()">
                  <span class="custom-checkbox-display">
                    <img src="assets/icons/check.svg" class="custom-checkbox-checkmark" *ngIf="selectedSizes[size.value]">
                  </span>
                  <span class="custom-checkbox-text">{{ size.translationKey | translate }}</span>
                </label>
              </div>
            </div>
          </div>

          <button class="button button-clear-filters" (click)="clearFilters()">{{ tKeys.SF_CATEGORY_BUTTON_CLEAR_ALL_FILTERS | translate }}</button>
        </div>
      </aside>

      <!-- Main Product Listing Area -->
      <main class="product-listing-area animate-main-content">

        <!-- Sort Bar & Mobile Filter Trigger -->
        <div class="sort-bar-container">
          <div class="sort-controls">
            <label for="sort-select" class="sort-label">{{ tKeys.SF_CATEGORY_SORT_BY_LABEL | translate }}:</label>
            <div class="filter-select-wrapper">
              <select id="sort-select" class="sort-select" [ngModel]="sortSubject.value" (ngModelChange)="onSortChange($event)">
                <option value="newest">{{ tKeys.SF_CATEGORY_SORT_NEWEST | translate }}</option>
                <option value="price-asc">{{ tKeys.SF_CATEGORY_SORT_PRICE_LOW_HIGH | translate }}</option>
                <option value="price-desc">{{ tKeys.SF_CATEGORY_SORT_PRICE_HIGH_LOW | translate }}</option>
                <option value="name-asc">{{ tKeys.SF_CATEGORY_SORT_NAME_A_Z | translate }}</option>
                <!-- Add 'best-selling' if supported by API and desired -->
              </select>
              <img src="assets/icons/chevron-down.svg" alt="dropdown arrow" class="icon icon-select-arrow">
            </div>
          </div>
          <button #filterButton class="button-mobile-filter mobile-only" (click)="toggleMobileFilters()">
            <img src="assets/icons/filter.svg" alt="filter" class="icon icon-filter">
            <span class="button-mobile-filter-text">{{ tKeys.SF_CATEGORY_FILTERS_TITLE | translate }}</span>
          </button>
        </div>

        <!-- Mobile Filter Overlay -->
        <div #mobileFilterOverlay class="mobile-filter-overlay" *ngIf="isMobileFiltersVisible">
          <aside class="filter-sidebar-content mobile-filters">
            <div class="mobile-filters-header">
              <h2 class="filters-title">{{ tKeys.SF_CATEGORY_FILTERS_TITLE | translate }}</h2>
              <button class="button-close-mobile-filters" (click)="toggleMobileFilters()">
                <img src="assets/icons/x.svg" alt="close" class="icon icon-close">
              </button>
            </div>
            <!-- Price Filter (Mobile) -->
            <div class="filter-group">
              <h3 class="filter-group-title">{{ tKeys.SF_CATEGORY_FILTER_PRICE_RANGE | translate }}</h3>
              <!-- Replaced select with checkboxes for price ranges - Mobile -->
              <div *ngFor="let priceRange of availablePriceRanges" class="filter-checkbox-item">
                <label class="custom-checkbox-label">
                  <input type="checkbox" class="native-checkbox-hidden" [(ngModel)]="selectedPriceRanges[priceRange.id]" (ngModelChange)="applyFilters()">
                  <span class="custom-checkbox-display">
                    <img src="assets/icons/check.svg" class="custom-checkbox-checkmark" *ngIf="selectedPriceRanges[priceRange.id]">
                  </span>
                  <span class="custom-checkbox-text">{{ (priceRange.labelTranslationKey | translate) || priceRange.id }}</span>
                </label>
              </div>
            </div>
            <!-- Tags Filter -->
            <div class="filter-group">
              <h3 class="filter-group-title">{{ tKeys.SF_CATEGORY_FILTER_TAGS | translate }}</h3>
              <div *ngFor="let tag of availableTags" class="filter-checkbox-item">
                <label class="custom-checkbox-label">
                  <input type="checkbox" class="native-checkbox-hidden" [(ngModel)]="selectedTags[tag.value]" (ngModelChange)="applyFilters()">
                  <span class="custom-checkbox-display">
                    <img src="assets/icons/check.svg" class="custom-checkbox-checkmark" *ngIf="selectedTags[tag.value]">
                  </span>
                  <span class="custom-checkbox-text">{{ tag.translationKey | translate }}</span>
                </label>
              </div>
            </div>
            <!-- Colors Filter -->
            <div class="filter-group">
              <h3 class="filter-group-title">{{ tKeys.SF_CATEGORY_FILTER_COLORS | translate }}</h3>
              <div *ngFor="let color of availableColors" class="filter-checkbox-item">
                <label class="custom-checkbox-label">
                  <input type="checkbox" class="native-checkbox-hidden" [(ngModel)]="selectedColors[color.value]" (ngModelChange)="applyFilters()">
                  <span class="custom-checkbox-display color-swatch-checkbox" [style.backgroundColor]="color.colorHex" [class.is-white]="color.value === 'White'">
                    <img src="assets/icons/check.svg" class="custom-checkbox-checkmark" *ngIf="selectedColors[color.value]" [class.checkmark-dark]="color.value !== 'Black'">
                  </span>
                  <span class="custom-checkbox-text">{{ color.translationKey | translate }}</span>
                </label>
              </div>
            </div>
            <!-- Sizes Filter -->
            <div class="filter-group">
              <h3 class="filter-group-title">{{ tKeys.SF_CATEGORY_FILTER_SIZES | translate }}</h3>
              <div *ngFor="let size of availableSizes" class="filter-checkbox-item">
                <label class="custom-checkbox-label">
                  <input type="checkbox" class="native-checkbox-hidden" [(ngModel)]="selectedSizes[size.value]" (ngModelChange)="applyFilters()">
                  <span class="custom-checkbox-display">
                    <img src="assets/icons/check.svg" class="custom-checkbox-checkmark" *ngIf="selectedSizes[size.value]">
                  </span>
                  <span class="custom-checkbox-text">{{ size.translationKey | translate }}</span>
                </label>
              </div>
            </div>
            <button class="button button-clear-filters" (click)="clearFilters(); toggleMobileFilters()">{{ tKeys.SF_CATEGORY_BUTTON_CLEAR_ALL_FILTERS | translate }}</button>
            <button class="button button-apply-filters-mobile" (click)="toggleMobileFilters()">{{ tKeys.SF_CATEGORY_BUTTON_APPLY_FILTERS | translate }}</button>
          </aside>
        </div>

        <!-- Results Summary -->
        <div class="results-summary animate-results-summary" *ngIf="(products$ | async)?.length">
          <p>
            {{ tKeys.SF_CATEGORY_SHOWING_X_OF_Y_PRODUCTS | translate: { count: (products$ | async)?.length ?? 0, total: (totalProducts$ | async) ?? 0 } }}
            <!-- For "filtered from Z total", we'd need the original unfiltered category total -->
          </p>
        </div>

        <!-- Product Grid -->
        <div class="product-grid-container animate-product-grid">
          <ng-container *ngIf="products$ | async as products; else loadingProducts">
            <div class="product-grid" *ngIf="products.length > 0; else noProducts">
              <app-featured-product-card
                *ngFor="let product of products"
                [product]="product"
                [storeSlug]="currentStoreSlug$ | async"
                (addToCart)="onAddToCart($event)"
              ></app-featured-product-card>
            </div>
            <ng-template #noProducts>
              <p class="no-products-message">{{ tKeys.SF_CATEGORY_NO_PRODUCTS_FOUND | translate }}</p>
            </ng-template>
          </ng-container>
          <ng-template #loadingProducts>
            <p class="loading-message">{{ tKeys.SF_CATEGORY_LOADING_PRODUCTS | translate }}</p>
          </ng-template>
        </div>

        <!-- Pagination -->
        <div class="pagination-controls-wrapper animate-pagination" *ngIf="{ total: totalProducts$ | async, page: page$ | async } as paginationData">
          <ng-container *ngIf="paginationData.total !== null && paginationData.page !== null && paginationData.total > 0 && calculateTotalPages(paginationData.total) > 1">
            <div class="pagination-controls">
              <button class="button-pagination prev" (click)="onPageChange(paginationData.page - 1)" [disabled]="paginationData.page <= 1">
                <img src="assets/icons/chevron-left.svg" alt="previous" class="icon icon-pagination-arrow icon-prev">
                <span class="button-pagination-text">{{ tKeys.SF_CATEGORY_PAGINATION_PREVIOUS | translate }}</span>
              </button>
              <span class="pagination-info">
                {{ tKeys.SF_CATEGORY_PAGINATION_PAGE_X_OF_Y | translate:{ currentPage: paginationData.page, totalPages: calculateTotalPages(paginationData.total) } }}
              </span>
              <button class="button-pagination next" (click)="onPageChange(paginationData.page + 1)" [disabled]="paginationData.page >= calculateTotalPages(paginationData.total)">
                <span class="button-pagination-text">{{ tKeys.SF_CATEGORY_PAGINATION_NEXT | translate }}</span>
                <img src="assets/icons/chevron-right.svg" alt="next" class="icon icon-pagination-arrow icon-next">
              </button>
            </div>
            <!-- The "total products" text from React is part of the results summary now -->
          </ng-container>
        </div>

      </main> <!-- End .product-listing-area -->
    </div> <!-- End .main-content-area -->
  </div> <!-- End .content-container -->
</div> <!-- End .page-wrapper -->


<!-- Loading template for category -->
<ng-template #loadingCategory>
  <p class="loading-message">{{ tKeys.SF_CATEGORY_LOADING_DETAILS | translate }}</p>
</ng-template>