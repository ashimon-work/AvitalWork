<!-- Main container, waits for category data -->
<div class="category-page-container" *ngIf="category$ | async as category; else loadingCategory">

  <!-- Breadcrumbs -->
  <div class="breadcrumbs">
    <a [routerLink]="[ (currentStoreSlug$ | async) ? '/' + (currentStoreSlug$ | async) : '/']">Home</a> > <span>{{ category.name }}</span>
  </div>

  <!-- Category Header -->
  <div class="category-header">
    <h1>{{ category.name }}</h1>
    <p>{{ category.description }}</p>
  </div>

  <!-- Grid container for filters and main content -->
  <div class="category-content">

    <!-- Filter Sidebar (Desktop - Moved inside grid) -->
    <div class="filter-wrapper desktop-only"> <!-- Hide on mobile -->
      <aside class="filter-sidebar">
        <h2>Filters</h2>
        <!-- Price Filter Example -->
        <div class="filter-group">
          <h3>Price Range</h3>
          <select [(ngModel)]="selectedPriceRange" (ngModelChange)="applyFilters()">
            <option value="">All Prices</option>
            <option value="0-20">$0 - $20</option>
            <option value="20-50">$20 - $50</option>
            <option value="50-100">$50 - $100</option>
            <option value="100-Infinity">$100+</option>
          </select>
        </div>
        <!-- Tags Filter Example -->
        <div class="filter-group">
          <h3>Tags</h3>
          <div *ngFor="let tag of ['New', 'Sale', 'Featured']">
            <label>
              <input type="checkbox" [(ngModel)]="selectedTags[tag]" (ngModelChange)="applyFilters()">
              {{ tag }}
            </label>
          </div>
        </div>
        <!-- Add other filters -->
        <button (click)="clearFilters()">Clear All Filters</button>
      </aside>
    </div>

    <!-- Main Content Area (Now correctly placed in the second grid column) -->
    <main class="main-content">
      <!-- Sorting Options -->
      <div class="sorting-options">
        <!-- Mobile Filter Trigger -->
        <button #filterButton class="filter-button mobile-only" (click)="toggleMobileFilters()">Filters</button> <!-- Added click handler &amp; template ref -->
        <!-- Desktop Sort Controls -->
        <div class="sort-controls">
          <label for="sort">Sort by:</label>
          <select id="sort" [ngModel]="sortSubject.value" (ngModelChange)="onSortChange($event)">
            <option value="newest">Newest</option>
            <option value="price-asc">Price Low-High</option>
            <option value="price-desc">Price High-Low</option>
            <option value="name-asc">Name A-Z</option>
          </select>
        </div>

        <!-- Mobile Filter Overlay - Moved inside sorting-options &amp; added template ref -->
        <div #mobileFilterOverlay class="mobile-filter-overlay" *ngIf="isMobileFiltersVisible">
          <aside class="filter-sidebar mobile-filters"> <!-- Re-use sidebar structure -->
            <button class="close-filters" (click)="toggleMobileFilters()">&amp;times;</button> <!-- Close button -->
            <h2>Filters</h2>
            <!-- Price Filter Example -->
            <div class="filter-group">
              <h3>Price Range</h3>
              <select [(ngModel)]="selectedPriceRange" (ngModelChange)="applyFilters(); toggleMobileFilters()"> <!-- Close on change -->
                <option value="">All Prices</option>
                <option value="0-20">$0 - $20</option>
                <option value="20-50">$20 - $50</option>
                <option value="50-100">$50 - $100</option>
                <option value="100-Infinity">$100+</option>
              </select>
            </div>
            <!-- Tags Filter Example -->
            <div class="filter-group">
              <h3>Tags</h3>
              <div *ngFor="let tag of ['New', 'Sale', 'Featured']">
                <label>
                  <input type="checkbox" [(ngModel)]="selectedTags[tag]" (ngModelChange)="applyFilters()"> <!-- Don't close on checkbox change -->
                  {{ tag }}
                </label>
              </div>
            </div>
            <!-- Add other filters -->
            <button (click)="clearFilters(); toggleMobileFilters()">Clear All Filters</button> <!-- Close on clear -->
            <button class="apply-filters-mobile" (click)="toggleMobileFilters()">Apply Filters</button> <!-- Explicit Apply/Close button -->
          </aside>
        </div>
      </div>

      <!-- Product Grid -->
      <div class="product-grid-wrapper">
        <ng-container *ngIf="products$ | async as products; else loadingProducts">
          <div class="product-grid" *ngIf="products.length > 0; else noProducts">
            <app-product-card *ngFor="let product of products" [product]="product" [storeSlug]="currentStoreSlug$ | async" [categoryId]="category.id"></app-product-card>
          </div>
          <ng-template #noProducts>
            <p>No products found matching your criteria.</p>
          </ng-template>
        </ng-container>
        <ng-template #loadingProducts><p>Loading products...</p></ng-template>
      </div>


      <!-- Pagination -->
      <div class="pagination" *ngIf="{ total: totalProducts$ | async, page: page$ | async } as paginationData">
         <ng-container *ngIf="paginationData.total !== null &amp;&amp; paginationData.page !== null &amp;&amp; paginationData.total > 0">
           <button (click)="onPageChange(paginationData.page - 1)" [disabled]="paginationData.page <= 1">Previous</button>
           <span>Page {{ paginationData.page }} of {{ calculateTotalPages(paginationData.total) }}</span>
           <button (click)="onPageChange(paginationData.page + 1)" [disabled]="paginationData.page >= calculateTotalPages(paginationData.total)">Next</button>
           <p>Total Products: {{ paginationData.total }}</p>
         </ng-container>
      </div>
    </main>

  </div> <!-- End .category-content -->
</div>


<!-- Loading template for category -->
<ng-template #loadingCategory><p>Loading category details...</p></ng-template>
