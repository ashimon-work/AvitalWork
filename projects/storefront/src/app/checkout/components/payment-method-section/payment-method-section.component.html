<div class="payment-wrapper" dir="rtl">
  <h2 class="section-title">תשלום</h2>
  <span class="section-subtitle">כרטיסים שמורים</span>
  <div class="payment-options-list">
    
    <div *ngFor="let card of $any(storedCard); let i = index" 
            class="pill-container pill-container--header" 
            [class.active]="!isModalOpen && i === 0"
            (click)="isModalOpen = false">
          
          <div class="radio-circle">
            <div class="radio-dot" *ngIf="!isModalOpen && i === 0"></div>
          </div>
          
          <div class="pill-content">
            <span class="pill-label">{{ card?.brand }} •••• {{ card?.last4 }}</span>
          </div>
    </div>
    <div class="pill-container pill-container--header" 
         [class.active]="isModalOpen"
         (click)="isModalOpen = true">
      <div class="radio-circle">
        <div class="radio-dot" *ngIf="isModalOpen"></div>
      </div>
      <span class="pill-label">השתמש בכרטיס חדש</span>
    </div>

  </div>

  <div class="fields-expansion" *ngIf="isModalOpen">
    
<div class="pill-container pill-container--input">
      <input type="text" 
             class="clean-input" 
             placeholder="מספר כרטיס "
             maxlength="16"
             inputmode="numeric"
             oninput="this.value = this.value.replace(/[^0-9]/g, '')">
    </div>

    <div class="inputs-grid">
      <div class="pill-container pill-container--input">
        <input type="text" 
               class="clean-input" 
               placeholder="חודש"
               maxlength="2"
               inputmode="numeric"
               oninput="this.value = this.value.replace(/[^0-9]/g, '')">
      </div>

      <div class="pill-container pill-container--input">
        <input type="text" 
               class="clean-input" 
               placeholder="שנה"
               maxlength="2"
               inputmode="numeric"
               oninput="this.value = this.value.replace(/[^0-9]/g, '')">
      </div>

      <div class="pill-container pill-container--input">
        <input type="text" 
               class="clean-input" 
               placeholder="CVC"
               maxlength="4"
               inputmode="numeric"
               oninput="this.value = this.value.replace(/[^0-9]/g, '')">
      </div>
    
    </div>
  </div>
  <div class="fields-expansion" *ngIf="isModalOpen">
<div class="checkbox-line" (click)="saveCardRef.checked = !saveCardRef.checked">
  
  <input type="checkbox" #saveCardRef hidden> 
  
  <div class="custom-v-check" [class.active]="saveCardRef.checked">
    <svg *ngIf="saveCardRef.checked" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
  </div>
  
  <span class="checkbox-label">שמור כרטיס זה לרכישות עתידיות</span>
</div>
</div>
  <div class="billing-section">
    <h2 class="section-title">כתובת חיוב</h2>
    
    <div class="checkbox-line" (click)="showBillingForm = !showBillingForm">
      <div class="custom-v-check" [class.active]="!showBillingForm">
        <svg *ngIf="!showBillingForm" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
      </div>
      <label class="checkbox-label">כתובת חיוב זהה לכתובת משלוח</label>
    </div>

    <div *ngIf="showBillingForm" class="billing-form-container">
       <app-shipping-address-form (formUpdate)="handleBillingSubmit($event)"></app-shipping-address-form>
    </div>
  </div>
</div>
