<div class="checkout-container container my-5">
  <h1 class="text-center mb-4">Checkout</h1>

  <!-- Progress Bar/Steps Indicator -->
  <div class="progress-indicator mb-4 d-flex justify-content-around">
    <button type="button" class="btn step-indicator" [class.active]="(currentStep | async) === 1" (click)="goToStep(1)" [disabled]="(currentStep | async)! < 1">1. Shipping</button>
    <button type="button" class="btn step-indicator" [class.active]="(currentStep | async) === 2" (click)="goToStep(2)" [disabled]="(currentStep | async)! < 2">2. Payment</button>
    <button type="button" class="btn step-indicator" [class.active]="(currentStep | async) === 3" (click)="goToStep(3)" [disabled]="(currentStep | async)! < 3">3. Review</button>
  </div>

  <form [formGroup]="checkoutForm" (ngSubmit)="placeOrder()">
    <div class="checkout-content d-flex flex-column flex-lg-row">
      <div class="checkout-form-sections flex-grow-1 me-lg-4">

        <!-- Step 1: Shipping Information & Method -->
        <div *ngIf="(currentStep | async) === 1" class="step-content card shadow-sm mb-4">
          <div class="card-body">
            <section class="shipping-info" formGroupName="shippingAddress">
              <h4 class="mb-3">Shipping Address</h4>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="sa_firstName" class="form-label">First Name</label>
                  <input id="sa_firstName" type="text" class="form-control" formControlName="firstName">
                  <div *ngIf="checkoutForm.get('shippingAddress.firstName')?.invalid && checkoutForm.get('shippingAddress.firstName')?.touched" class="invalid-feedback d-block">
                    First Name is required.
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="sa_lastName" class="form-label">Last Name</label>
                  <input id="sa_lastName" type="text" class="form-control" formControlName="lastName">
                  <div *ngIf="checkoutForm.get('shippingAddress.lastName')?.invalid && checkoutForm.get('shippingAddress.lastName')?.touched" class="invalid-feedback d-block">
                    Last Name is required.
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label for="sa_address1" class="form-label">Address Line 1</label>
                <input id="sa_address1" type="text" class="form-control" formControlName="address1">
                <div *ngIf="checkoutForm.get('shippingAddress.address1')?.invalid && checkoutForm.get('shippingAddress.address1')?.touched" class="invalid-feedback d-block">
                  Address is required.
                </div>
              </div>
              <div class="mb-3">
                <label for="sa_address2" class="form-label">Address Line 2 <span class="text-muted">(Optional)</span></label>
                <input id="sa_address2" type="text" class="form-control" formControlName="address2">
              </div>
              <div class="row">
                <div class="col-md-5 mb-3">
                  <label for="sa_city" class="form-label">City</label>
                  <input id="sa_city" type="text" class="form-control" formControlName="city">
                  <div *ngIf="checkoutForm.get('shippingAddress.city')?.invalid && checkoutForm.get('shippingAddress.city')?.touched" class="invalid-feedback d-block">
                    City is required.
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="sa_zipCode" class="form-label">Zip/Postal Code</label>
                  <input id="sa_zipCode" type="text" class="form-control" formControlName="zipCode">
                  <div *ngIf="checkoutForm.get('shippingAddress.zipCode')?.invalid && checkoutForm.get('shippingAddress.zipCode')?.touched" class="invalid-feedback d-block">
                    Zip Code is required.
                  </div>
                </div>
                <div class="col-md-3 mb-3">
                  <label for="sa_country" class="form-label">Country</label>
                  <input id="sa_country" type="text" class="form-control" formControlName="country" readonly>
                </div>
              </div>
            </section>

            <hr class="my-4">

            <section class="shipping-method">
              <h4 class="mb-3">Shipping Method</h4>
              <div *ngIf="(shippingMethods$ | async) as methods; else loadingShipping">
                <div *ngIf="methods.length > 0; else noShippingMethods" class="list-group">
                  <label *ngFor="let method of methods" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <div>
                      <input type="radio" class="form-check-input me-2" [value]="method.id" formControlName="shippingMethod">
                      {{ method.name }}
                      <small *ngIf="method.description" class="d-block text-muted">{{ method.description }}</small>
                    </div>
                    <span class="fw-bold">{{ method.cost | currency }}</span>
                  </label>
                </div>
                <ng-template #noShippingMethods>
                  <p class="text-muted">No shipping methods available for your address.</p>
                </ng-template>
              </div>
              <ng-template #loadingShipping>
                <p>Loading shipping methods...</p>
              </ng-template>
              <div *ngIf="checkoutForm.get('shippingMethod')?.invalid && checkoutForm.get('shippingMethod')?.touched" class="invalid-feedback d-block mt-2">
                Please select a shipping method.
              </div>
            </section>
            <div class="d-flex justify-content-end mt-4">
              <button type="button" class="btn btn-primary" (click)="nextStep()">Next: Payment</button>
            </div>
          </div>
        </div>

        <!-- Step 2: Payment Information & Billing Address -->
        <div *ngIf="(currentStep | async) === 2" class="step-content card shadow-sm mb-4">
          <div class="card-body">
            <section class="payment-info" formGroupName="paymentInfo">
              <h4 class="mb-3">Payment Information</h4>
              <div class="mb-3">
                <label for="pi_cardNumber" class="form-label">Card Number</label>
                <input id="pi_cardNumber" type="text" class="form-control" formControlName="cardNumber" placeholder="•••• •••• •••• ••••">
                <!-- TODO: Add specific card validation messages -->
                <div *ngIf="checkoutForm.get('paymentInfo.cardNumber')?.invalid && checkoutForm.get('paymentInfo.cardNumber')?.touched" class="invalid-feedback d-block">
                  Valid Card Number is required.
                </div>
              </div>
              <div class="row">
                <div class="col-md-7 mb-3">
                  <label for="pi_expiryDate" class="form-label">Expiry Date</label>
                  <input id="pi_expiryDate" type="text" class="form-control" formControlName="expiryDate" placeholder="MM/YY">
                  <div *ngIf="checkoutForm.get('paymentInfo.expiryDate')?.invalid && checkoutForm.get('paymentInfo.expiryDate')?.touched" class="invalid-feedback d-block">
                    Expiry Date is required (MM/YY).
                  </div>
                </div>
                <div class="col-md-5 mb-3">
                  <label for="pi_cvv" class="form-label">CVV</label>
                  <input id="pi_cvv" type="text" class="form-control" formControlName="cvv" placeholder="•••">
                  <div *ngIf="checkoutForm.get('paymentInfo.cvv')?.invalid && checkoutForm.get('paymentInfo.cvv')?.touched" class="invalid-feedback d-block">
                    CVV is required.
                  </div>
                </div>
              </div>
              <!-- Placeholder for integrated payment gateway element (e.g., Stripe Elements) -->
              <div id="card-element" class="my-3 p-2 border rounded"></div>
              <div id="card-errors" role="alert" class="text-danger small mt-1"></div>

            </section>

            <hr class="my-4">

            <section class="billing-address">
              <h4 class="mb-3">Billing Address</h4>
              <div class="form-check mb-3">
                <input type="checkbox" class="form-check-input" id="billingSameAsShipping" formControlName="billingAddressSameAsShipping">
                <label class="form-check-label" for="billingSameAsShipping">Billing address is the same as shipping</label>
              </div>

              <div *ngIf="!checkoutForm.get('billingAddressSameAsShipping')?.value" formGroupName="billingAddress">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="ba_firstName" class="form-label">First Name</label>
                    <input id="ba_firstName" type="text" class="form-control" formControlName="firstName">
                     <div *ngIf="checkoutForm.get('billingAddress.firstName')?.invalid && checkoutForm.get('billingAddress.firstName')?.touched" class="invalid-feedback d-block">First Name is required.</div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="ba_lastName" class="form-label">Last Name</label>
                    <input id="ba_lastName" type="text" class="form-control" formControlName="lastName">
                    <div *ngIf="checkoutForm.get('billingAddress.lastName')?.invalid && checkoutForm.get('billingAddress.lastName')?.touched" class="invalid-feedback d-block">Last Name is required.</div>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="ba_address1" class="form-label">Address Line 1</label>
                  <input id="ba_address1" type="text" class="form-control" formControlName="address1">
                  <div *ngIf="checkoutForm.get('billingAddress.address1')?.invalid && checkoutForm.get('billingAddress.address1')?.touched" class="invalid-feedback d-block">Address is required.</div>
                </div>
                <div class="mb-3">
                  <label for="ba_address2" class="form-label">Address Line 2 <span class="text-muted">(Optional)</span></label>
                  <input id="ba_address2" type="text" class="form-control" formControlName="address2">
                </div>
                <div class="row">
                  <div class="col-md-5 mb-3">
                    <label for="ba_city" class="form-label">City</label>
                    <input id="ba_city" type="text" class="form-control" formControlName="city">
                    <div *ngIf="checkoutForm.get('billingAddress.city')?.invalid && checkoutForm.get('billingAddress.city')?.touched" class="invalid-feedback d-block">City is required.</div>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="ba_zipCode" class="form-label">Zip/Postal Code</label>
                    <input id="ba_zipCode" type="text" class="form-control" formControlName="zipCode">
                    <div *ngIf="checkoutForm.get('billingAddress.zipCode')?.invalid && checkoutForm.get('billingAddress.zipCode')?.touched" class="invalid-feedback d-block">Zip Code is required.</div>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="ba_country" class="form-label">Country</label>
                    <input id="ba_country" type="text" class="form-control" formControlName="country" readonly>
                  </div>
                </div>
              </div>
            </section>
            <div class="d-flex justify-content-between mt-4">
              <button type="button" class="btn btn-secondary" (click)="prevStep()">Back to Shipping</button>
              <button type="button" class="btn btn-primary" (click)="nextStep()">Next: Review Order</button>
            </div>
          </div>
        </div>

        <!-- Step 3: Review Order -->
        <div *ngIf="(currentStep | async) === 3" class="step-content card shadow-sm mb-4">
          <div class="card-body">
            <h4 class="mb-3">Review Your Order</h4>
            <!-- Display summary of shipping, billing, payment, items -->
            <div class="review-section mb-3">
              <h5>Shipping Address:</h5>
              <p>{{ checkoutForm.get('shippingAddress.firstName')?.value }} {{ checkoutForm.get('shippingAddress.lastName')?.value }}</p>
              <p>{{ checkoutForm.get('shippingAddress.address1')?.value }}</p>
              <p *ngIf="checkoutForm.get('shippingAddress.address2')?.value">{{ checkoutForm.get('shippingAddress.address2')?.value }}</p>
              <p>{{ checkoutForm.get('shippingAddress.city')?.value }}, {{ checkoutForm.get('shippingAddress.zipCode')?.value }}</p>
              <p>{{ checkoutForm.get('shippingAddress.country')?.value }}</p>
            </div>
             <div class="review-section mb-3">
              <h5>Shipping Method:</h5>
              <p>{{ selectedShippingMethod?.name }} - {{ selectedShippingMethod?.cost | currency }}</p>
            </div>
            <div class="review-section mb-3">
              <h5>Billing Address:</h5>
              <div *ngIf="checkoutForm.get('billingAddressSameAsShipping')?.value; else customBilling">
                <p>Same as shipping address.</p>
              </div>
              <ng-template #customBilling>
                <p>{{ checkoutForm.get('billingAddress.firstName')?.value }} {{ checkoutForm.get('billingAddress.lastName')?.value }}</p>
                <p>{{ checkoutForm.get('billingAddress.address1')?.value }}</p>
                <p *ngIf="checkoutForm.get('billingAddress.address2')?.value">{{ checkoutForm.get('billingAddress.address2')?.value }}</p>
                <p>{{ checkoutForm.get('billingAddress.city')?.value }}, {{ checkoutForm.get('billingAddress.zipCode')?.value }}</p>
                <p>{{ checkoutForm.get('billingAddress.country')?.value }}</p>
              </ng-template>
            </div>
            <div class="review-section mb-3">
              <h5>Payment Method:</h5>
              <p>Card ending in: {{ checkoutForm.get('paymentInfo.cardNumber')?.value | slice:-4 }}</p>
              <!-- Mask sensitive details -->
            </div>

            <hr class="my-4">
            <div class="terms-newsletter mb-3">
              <div class="form-check mb-2">
                <input type="checkbox" class="form-check-input" id="newsletterOptIn" formControlName="newsletterOptIn">
                <label class="form-check-label" for="newsletterOptIn">Sign me up for the newsletter</label>
              </div>
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="termsAccepted" formControlName="termsAccepted">
                <label class="form-check-label" for="termsAccepted">I agree to the <a routerLink="/terms-and-conditions" target="_blank">Terms and Conditions</a></label>
                <div *ngIf="checkoutForm.get('termsAccepted')?.invalid && checkoutForm.get('termsAccepted')?.touched" class="invalid-feedback d-block">
                  You must accept the Terms and Conditions.
                </div>
              </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
              <button type="button" class="btn btn-secondary" (click)="prevStep()">Back to Payment</button>
              <button type="submit" class="btn btn-success btn-lg" [disabled]="checkoutForm.invalid || isLoading">
                {{ isLoading ? 'Processing...' : 'Place Order' }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Order Summary (Sticky Sidebar) -->
      <aside class="order-summary-sidebar ms-lg-4 mt-4 mt-lg-0 card shadow-sm" style="width: 320px;">
        <div class="card-body">
          <h4 class="mb-3">Order Summary</h4>
          <div *ngIf="cart$ | async as cart; else emptyCartSummary">
            <ul class="list-unstyled mb-3">
              <li *ngFor="let item of cart.items" class="d-flex justify-content-between py-2 border-bottom">
                <div>
                  <h6 class="my-0">{{ item.product.name }} <span class="text-muted">x {{ item.quantity }}</span></h6>
                  <small class="text-muted">{{ item.product.description | slice:0:50 }}{{ (item.product.description && item.product.description.length > 50) ? '...' : '' }}</small> <!-- Use description and slice -->
                </div>
                <span class="text-muted">{{ item.product.price * item.quantity | currency }}</span>
              </li>
            </ul>

            <ul class="list-unstyled">
              <li class="d-flex justify-content-between py-1">
                <span>Subtotal:</span>
                <strong>{{ cart.subtotal | currency }}</strong>
              </li>
              <li class="d-flex justify-content-between py-1">
                <span>Shipping:</span>
                <strong>{{ selectedShippingMethod?.cost | currency:'USD':'symbol':'1.2-2' : 'N/A' }}</strong>
              </li>
              <li class="d-flex justify-content-between py-1">
                <span>Tax Estimate:</span>
                <strong>{{ (taxEstimate$ | async) | currency }}</strong>
              </li>
              <li class="d-flex justify-content-between py-2 border-top mt-2 fs-5">
                <span>Order Total:</span>
                <strong class="fw-bold">{{ (orderTotal$ | async) | currency }}</strong>
              </li>
            </ul>
          </div>
          <ng-template #emptyCartSummary>
            <p class="text-muted">Your cart is empty.</p>
          </ng-template>

          <div *ngIf="(currentStep | async) === 3" class="security-badges text-center mt-3">
            <small class="text-muted d-block mb-1">Secure Checkout</small>
            <!-- Placeholder for actual badges -->
            <img src="https://via.placeholder.com/100x40.png?text=Secure" alt="Secure Checkout" class="me-1">
            <img src="https://via.placeholder.com/100x40.png?text=SSL" alt="SSL Secured">
          </div>
        </div>
      </aside>
    </div>
  </form>
</div>
