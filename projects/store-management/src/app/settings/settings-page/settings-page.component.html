<!-- Settings Page -->
<div class="settings-container">
  <h1>{{ tKeys.SM_SETTINGS_PAGE_TITLE | translate }}</h1>

  <div class="settings-layout">
    <!-- Left Sidebar for Setting Categories -->
    <aside class="settings-sidebar">
      <ul class="nav flex-column">
        <li class="nav-item" *ngFor="let category of settingCategories">
          <a class="nav-link"
             [routerLink]="['/manager', storeContextService.currentStoreSlug$ | async, 'settings', category]"
             [class.active]="currentCategory === category">
            {{ tKeys[getCategoryTranslationKey(category)] | translate }}
          </a>
        </li>
      </ul>
    </aside>

    <!-- Main Content Area for Settings Forms -->
    <main class="settings-content">
      <ng-container *ngIf="isLoading">
        <p>{{ tKeys.SM_SETTINGS_PAGE_LOADING | translate }}</p>
      </ng-container>

      <ng-container *ngIf="error">
        <p class="text-danger">{{ tKeys.SM_SETTINGS_PAGE_ERROR_LOADING | translate:{ error: (error | json) } }}</p>
      </ng-container>

      <ng-container *ngIf="!isLoading && !error && settings">
        <section class="settings-section">
          <h2>{{ tKeys.SM_SETTINGS_PAGE_CATEGORY_SECTION_TITLE | translate:(tKeys[getCategoryTranslationKey(currentCategory)] | translate) }}</h2>
          <!-- Editable settings form -->
          <form *ngIf="editableSettings">

            <!-- General Settings -->
            <div *ngIf="currentCategory === 'general'">
              <div class="mb-3">
                <label for="storeName" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_GENERAL_STORE_NAME_LABEL | translate }}</label>
                <input type="text" class="form-control" id="storeName" name="storeName" [(ngModel)]="editableSettings.storeName">
              </div>
              <div class="mb-3">
                <label for="storeEmail" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_GENERAL_STORE_EMAIL_LABEL | translate }}</label>
                <input type="email" class="form-control" id="storeEmail" name="storeEmail" [(ngModel)]="editableSettings.storeEmail">
              </div>
              <div class="mb-3">
                <label for="storePhone" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_GENERAL_STORE_PHONE_LABEL | translate }}</label>
                <input type="tel" class="form-control" id="storePhone" name="storePhone" [(ngModel)]="editableSettings.storePhone">
              </div>
              <div class="mb-3">
                <label for="storeAddress" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_GENERAL_STORE_ADDRESS_LABEL | translate }}</label>
                <textarea class="form-control" id="storeAddress" name="storeAddress" [(ngModel)]="editableSettings.storeAddress"></textarea>
              </div>
              <div class="mb-3">
                <label for="currency" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_GENERAL_CURRENCY_LABEL | translate }}</label>
                <input type="text" class="form-control" id="currency" name="currency" [(ngModel)]="editableSettings.currency">
                <!-- TODO: Consider a dropdown for currencies -->
              </div>
              <div class="mb-3">
                <label for="timezone" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_GENERAL_TIMEZONE_LABEL | translate }}</label>
                <input type="text" class="form-control" id="timezone" name="timezone" [(ngModel)]="editableSettings.timezone">
                <!-- TODO: Consider a dropdown for timezones -->
              </div>
            </div>

            <!-- Shipping Settings -->
            <div *ngIf="currentCategory === 'shipping'">
              <div class="mb-3">
                <label for="defaultShippingRate" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_SHIPPING_DEFAULT_RATE_LABEL | translate }}</label>
                <input type="number" class="form-control" id="defaultShippingRate" name="defaultShippingRate" [(ngModel)]="editableSettings.defaultShippingRate">
              </div>
              <div class="mb-3">
                <label for="freeShippingThreshold" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_SHIPPING_FREE_THRESHOLD_LABEL | translate }}</label>
                <input type="number" class="form-control" id="freeShippingThreshold" name="freeShippingThreshold" [(ngModel)]="editableSettings.freeShippingThreshold">
              </div>
              <!-- Add other shipping settings fields here -->
            </div>

            <!-- Payments Settings -->
            <div *ngIf="currentCategory === 'payments'">
              <div class="mb-3">
                <label for="acceptedPaymentMethods" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_PAYMENTS_ACCEPTED_METHODS_LABEL | translate }}</label>
                <input type="text" class="form-control" id="acceptedPaymentMethods" name="acceptedPaymentMethods" [(ngModel)]="editableSettings.acceptedPaymentMethods">
                <!-- TODO: Better UI for multiple selection e.g. checkboxes or tags input -->
              </div>
              <div class="mb-3">
                <label for="stripeApiKey" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_PAYMENTS_STRIPE_KEY_LABEL | translate }}</label>
                <input type="password" class="form-control" id="stripeApiKey" name="stripeApiKey" [(ngModel)]="editableSettings.stripeApiKey">
              </div>
              <div class="mb-3">
                <label for="paypalClientId" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_PAYMENTS_PAYPAL_ID_LABEL | translate }}</label>
                <input type="password" class="form-control" id="paypalClientId" name="paypalClientId" [(ngModel)]="editableSettings.paypalClientId">
              </div>
              <!-- Add other payment settings fields here -->

              <h4 class="mt-4">{{ tKeys.SM_SETTINGS_PAGE_PAYMENTS_TEST_CONFIG_TITLE | translate }}</h4>
              <div class="mb-3">
                <label for="testPaymentAmount" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_PAYMENTS_TEST_AMOUNT_LABEL | translate }}</label>
                <input type="number" class="form-control" id="testPaymentAmount" name="testPaymentAmount" [(ngModel)]="testPaymentAmount">
              </div>
              <div class="mb-3">
                <label for="testPaymentCurrency" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_PAYMENTS_TEST_CURRENCY_LABEL | translate }}</label>
                <input type="text" class="form-control" id="testPaymentCurrency" name="testPaymentCurrency" [(ngModel)]="testPaymentCurrency">
              </div>
              <button type="button" class="btn btn-secondary" (click)="testPaymentConfiguration()" [disabled]="isTestingPayment">
                <span *ngIf="isTestingPayment" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                {{ tKeys.SM_SETTINGS_PAGE_PAYMENTS_TEST_PAYMENT_BUTTON | translate }}
              </button>
            </div>

            <!-- Taxes Settings -->
            <div *ngIf="currentCategory === 'taxes'">
              <div class="mb-3">
                <label for="taxRate" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_TAXES_DEFAULT_RATE_LABEL | translate }}</label>
                <input type="number" step="0.001" class="form-control" id="taxRate" name="taxRate" [(ngModel)]="editableSettings.taxRate">
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="pricesIncludeTax" name="pricesIncludeTax" [(ngModel)]="editableSettings.pricesIncludeTax">
                <label class="form-check-label" for="pricesIncludeTax">
                  {{ tKeys.SM_SETTINGS_PAGE_TAXES_PRICES_INCLUDE_TAX_LABEL | translate }}
                </label>
              </div>
              <!-- Add other tax settings fields here -->
            </div>

            <!-- Notifications Settings -->
            <div *ngIf="currentCategory === 'notifications'">
              <div class="mb-3">
                <label for="adminEmailForOrders" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_NOTIFICATIONS_ADMIN_EMAIL_LABEL | translate }}</label>
                <input type="email" class="form-control" id="adminEmailForOrders" name="adminEmailForOrders" [(ngModel)]="editableSettings.adminEmailForOrders">
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="customerEmailForOrders" name="customerEmailForOrders" [(ngModel)]="editableSettings.customerEmailForOrders">
                <label class="form-check-label" for="customerEmailForOrders">
                  {{ tKeys.SM_SETTINGS_PAGE_NOTIFICATIONS_CUSTOMER_EMAIL_LABEL | translate }}
                </label>
              </div>
              <!-- Add other notification settings fields here -->

              <h4 class="mt-4">{{ tKeys.SM_SETTINGS_PAGE_NOTIFICATIONS_TEST_EMAIL_CONFIG_TITLE | translate }}</h4>
              <div class="mb-3">
                <label for="testEmailRecipient" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_NOTIFICATIONS_TEST_EMAIL_RECIPIENT_LABEL | translate }}</label>
                <input type="email" class="form-control" id="testEmailRecipient" name="testEmailRecipient" [(ngModel)]="testEmailRecipient">
              </div>
              <button type="button" class="btn btn-secondary" (click)="testEmailConfiguration()" [disabled]="isTestingEmail">
                <span *ngIf="isTestingEmail" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                {{ tKeys.SM_SETTINGS_PAGE_NOTIFICATIONS_TEST_EMAIL_BUTTON | translate }}
              </button>
            </div>

            <!-- Users & Permissions Settings -->
            <div *ngIf="currentCategory === 'users-permissions'">
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="allowRegistration" name="allowRegistration" [(ngModel)]="editableSettings.allowRegistration">
                <label class="form-check-label" for="allowRegistration">
                  {{ tKeys.SM_SETTINGS_PAGE_USERS_ALLOW_REGISTRATION_LABEL | translate }}
                </label>
              </div>
              <div class="mb-3">
                <label for="defaultRole" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_USERS_DEFAULT_ROLE_LABEL | translate }}</label>
                <input type="text" class="form-control" id="defaultRole" name="defaultRole" [(ngModel)]="editableSettings.defaultRole">
                <!-- TODO: Consider a dropdown for roles -->
              </div>
              <!-- Add other users-permissions settings fields here -->
            </div>

            <!-- Appearance Settings -->
            <div *ngIf="currentCategory === 'appearance'">
              <div class="mb-3">
                <label for="themeColor" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_APPEARANCE_THEME_COLOR_LABEL | translate }}</label>
                <input type="color" class="form-control form-control-color" id="themeColor" name="themeColor" [(ngModel)]="editableSettings.themeColor" [title]="tKeys.SM_SETTINGS_PAGE_APPEARANCE_CHOOSE_COLOR_TITLE | translate">
              </div>
              <div class="mb-3">
                <label for="logoUrl" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_APPEARANCE_LOGO_URL_LABEL | translate }}</label>
                <input type="url" class="form-control" id="logoUrl" name="logoUrl" [(ngModel)]="editableSettings.logoUrl">
              </div>
              <!-- Add other appearance settings fields here -->
            </div>

            <!-- Integrations Settings -->
            <div *ngIf="currentCategory === 'integrations'">
              <div class="mb-3">
                <label for="googleAnalyticsId" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_INTEGRATIONS_GA_ID_LABEL | translate }}</label>
                <input type="text" class="form-control" id="googleAnalyticsId" name="googleAnalyticsId" [(ngModel)]="editableSettings.googleAnalyticsId">
              </div>
              <div class="mb-3">
                <label for="facebookPixelId" class="form-label">{{ tKeys.SM_SETTINGS_PAGE_INTEGRATIONS_FB_PIXEL_ID_LABEL | translate }}</label>
                <input type="text" class="form-control" id="facebookPixelId" name="facebookPixelId" [(ngModel)]="editableSettings.facebookPixelId">
              </div>
              <!-- Add other integrations settings fields here -->
            </div>

            <div class="mt-4">
              <button type="button" class="btn btn-primary me-2" (click)="saveChanges()" [disabled]="isSaving || isResetting">
                <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                {{ tKeys.SM_SETTINGS_PAGE_SAVE_CHANGES_BUTTON | translate }}
              </button>
              <button type="button" class="btn btn-outline-secondary" (click)="resetToDefaults()" [disabled]="isResetting || isSaving">
                <span *ngIf="isResetting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                {{ tKeys.SM_SETTINGS_PAGE_RESET_TO_DEFAULTS_BUTTON | translate }}
              </button>
            </div>
          </form>
        </section>

        <section class="settings-section mt-5">
          <h2>{{ tKeys.SM_SETTINGS_PAGE_BACKUP_RESTORE_TITLE | translate }}</h2>
          <p>{{ tKeys.SM_SETTINGS_PAGE_BACKUP_RESTORE_DESCRIPTION | translate }}</p>
          <div class="mt-3">
            <button type="button" class="btn btn-info me-2" (click)="downloadBackup()" [disabled]="isDownloadingBackup">
              <span *ngIf="isDownloadingBackup" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              {{ tKeys.SM_SETTINGS_PAGE_DOWNLOAD_BACKUP_BUTTON | translate }}
            </button>
            <input type="file" #backupFileInput style="display: none;" (change)="onBackupFileSelected($event)" accept=".json">
            <button type="button" class="btn btn-outline-info me-2" (click)="backupFileInput.click()" [disabled]="isRestoringBackup">
              {{ tKeys.SM_SETTINGS_PAGE_SELECT_BACKUP_FILE_BUTTON | translate }}
            </button>
            <button type="button" class="btn btn-warning" (click)="restoreBackup()" [disabled]="!selectedBackupFile || isRestoringBackup">
              <span *ngIf="isRestoringBackup" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              {{ tKeys.SM_SETTINGS_PAGE_RESTORE_BACKUP_BUTTON | translate }}
            </button>
            <span *ngIf="selectedBackupFile" class="ms-2 align-middle">{{ tKeys.SM_SETTINGS_PAGE_SELECTED_FILE_TEXT | translate:selectedBackupFile.name }}</span>
          </div>
        </section>

      </ng-container>

      <ng-container *ngIf="!isLoading && !error && !settings && currentCategory">
        <p>{{ tKeys.SM_SETTINGS_PAGE_NO_SETTINGS_FOUND_FOR_CATEGORY | translate:(tKeys[getCategoryTranslationKey(currentCategory)] | translate) }}</p>
      </ng-container>
      <ng-container *ngIf="!isLoading && !error && !currentCategory">
        <p>{{ tKeys.SM_SETTINGS_PAGE_SELECT_CATEGORY_PROMPT | translate }}</p>
      </ng-container>

    </main>
  </div>
</div>