<!-- Settings Page -->
<div class="settings-container">
  <h1>Settings</h1>

  <div class="settings-layout">
    <!-- Left Sidebar for Setting Categories -->
    <aside class="settings-sidebar">
      <ul class="nav flex-column">
        <li class="nav-item" *ngFor="let category of settingCategories">
          <a class="nav-link"
             [routerLink]="['/manager', storeContextService.currentStoreSlug$ | async, 'settings', category]"
             [class.active]="currentCategory === category">
            {{ formatCategoryName(category) }}
          </a>
        </li>
      </ul>
    </aside>

    <!-- Main Content Area for Settings Forms -->
    <main class="settings-content">
      <ng-container *ngIf="isLoading">
        <p>Loading settings...</p>
      </ng-container>

      <ng-container *ngIf="error">
        <p class="text-danger">Error loading settings: {{ error | json }}</p>
      </ng-container>

      <ng-container *ngIf="!isLoading && !error && settings">
        <section class="settings-section">
          <h2>{{ formatCategoryName(currentCategory || '') }} Settings</h2>
          <!-- Editable settings form -->
          <form *ngIf="editableSettings">

            <!-- General Settings -->
            <div *ngIf="currentCategory === 'general'">
              <div class="mb-3">
                <label for="storeName" class="form-label">Store Name</label>
                <input type="text" class="form-control" id="storeName" name="storeName" [(ngModel)]="editableSettings.storeName">
              </div>
              <div class="mb-3">
                <label for="storeEmail" class="form-label">Store Email</label>
                <input type="email" class="form-control" id="storeEmail" name="storeEmail" [(ngModel)]="editableSettings.storeEmail">
              </div>
              <div class="mb-3">
                <label for="storePhone" class="form-label">Store Phone (Optional)</label>
                <input type="tel" class="form-control" id="storePhone" name="storePhone" [(ngModel)]="editableSettings.storePhone">
              </div>
              <div class="mb-3">
                <label for="storeAddress" class="form-label">Store Address (Optional)</label>
                <textarea class="form-control" id="storeAddress" name="storeAddress" [(ngModel)]="editableSettings.storeAddress"></textarea>
              </div>
              <div class="mb-3">
                <label for="currency" class="form-label">Currency</label>
                <input type="text" class="form-control" id="currency" name="currency" [(ngModel)]="editableSettings.currency">
                <!-- TODO: Consider a dropdown for currencies -->
              </div>
              <div class="mb-3">
                <label for="timezone" class="form-label">Timezone</label>
                <input type="text" class="form-control" id="timezone" name="timezone" [(ngModel)]="editableSettings.timezone">
                <!-- TODO: Consider a dropdown for timezones -->
              </div>
            </div>

            <!-- Shipping Settings -->
            <div *ngIf="currentCategory === 'shipping'">
              <div class="mb-3">
                <label for="defaultShippingRate" class="form-label">Default Shipping Rate</label>
                <input type="number" class="form-control" id="defaultShippingRate" name="defaultShippingRate" [(ngModel)]="editableSettings.defaultShippingRate">
              </div>
              <div class="mb-3">
                <label for="freeShippingThreshold" class="form-label">Free Shipping Threshold (Optional)</label>
                <input type="number" class="form-control" id="freeShippingThreshold" name="freeShippingThreshold" [(ngModel)]="editableSettings.freeShippingThreshold">
              </div>
              <!-- Add other shipping settings fields here -->
            </div>

            <!-- Payments Settings -->
            <div *ngIf="currentCategory === 'payments'">
              <div class="mb-3">
                <label for="acceptedPaymentMethods" class="form-label">Accepted Payment Methods (comma-separated)</label>
                <input type="text" class="form-control" id="acceptedPaymentMethods" name="acceptedPaymentMethods" [(ngModel)]="editableSettings.acceptedPaymentMethods">
                <!-- TODO: Better UI for multiple selection e.g. checkboxes or tags input -->
              </div>
              <div class="mb-3">
                <label for="stripeApiKey" class="form-label">Stripe API Key (Optional)</label>
                <input type="password" class="form-control" id="stripeApiKey" name="stripeApiKey" [(ngModel)]="editableSettings.stripeApiKey">
              </div>
              <div class="mb-3">
                <label for="paypalClientId" class="form-label">PayPal Client ID (Optional)</label>
                <input type="password" class="form-control" id="paypalClientId" name="paypalClientId" [(ngModel)]="editableSettings.paypalClientId">
              </div>
              <!-- Add other payment settings fields here -->

              <h4 class="mt-4">Test Payment Configuration</h4>
              <div class="mb-3">
                <label for="testPaymentAmount" class="form-label">Test Amount</label>
                <input type="number" class="form-control" id="testPaymentAmount" name="testPaymentAmount" [(ngModel)]="testPaymentAmount">
              </div>
              <div class="mb-3">
                <label for="testPaymentCurrency" class="form-label">Currency</label>
                <input type="text" class="form-control" id="testPaymentCurrency" name="testPaymentCurrency" [(ngModel)]="testPaymentCurrency">
              </div>
              <button type="button" class="btn btn-secondary" (click)="testPaymentConfiguration()" [disabled]="isTestingPayment">
                <span *ngIf="isTestingPayment" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Test Payment
              </button>
            </div>

            <!-- Taxes Settings -->
            <div *ngIf="currentCategory === 'taxes'">
              <div class="mb-3">
                <label for="taxRate" class="form-label">Default Tax Rate (e.g., 0.07 for 7%)</label>
                <input type="number" step="0.001" class="form-control" id="taxRate" name="taxRate" [(ngModel)]="editableSettings.taxRate">
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="pricesIncludeTax" name="pricesIncludeTax" [(ngModel)]="editableSettings.pricesIncludeTax">
                <label class="form-check-label" for="pricesIncludeTax">
                  Prices entered with tax included
                </label>
              </div>
              <!-- Add other tax settings fields here -->
            </div>

            <!-- Notifications Settings -->
            <div *ngIf="currentCategory === 'notifications'">
              <div class="mb-3">
                <label for="adminEmailForOrders" class="form-label">Admin Email for New Order Notifications</label>
                <input type="email" class="form-control" id="adminEmailForOrders" name="adminEmailForOrders" [(ngModel)]="editableSettings.adminEmailForOrders">
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="customerEmailForOrders" name="customerEmailForOrders" [(ngModel)]="editableSettings.customerEmailForOrders">
                <label class="form-check-label" for="customerEmailForOrders">
                  Send order confirmation email to customers
                </label>
              </div>
              <!-- Add other notification settings fields here -->

              <h4 class="mt-4">Test Email Configuration</h4>
              <div class="mb-3">
                <label for="testEmailRecipient" class="form-label">Recipient Email for Test</label>
                <input type="email" class="form-control" id="testEmailRecipient" name="testEmailRecipient" [(ngModel)]="testEmailRecipient">
              </div>
              <button type="button" class="btn btn-secondary" (click)="testEmailConfiguration()" [disabled]="isTestingEmail">
                <span *ngIf="isTestingEmail" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Test Email
              </button>
            </div>

            <!-- Users & Permissions Settings -->
            <div *ngIf="currentCategory === 'users-permissions'">
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="allowRegistration" name="allowRegistration" [(ngModel)]="editableSettings.allowRegistration">
                <label class="form-check-label" for="allowRegistration">
                  Allow new user registration
                </label>
              </div>
              <div class="mb-3">
                <label for="defaultRole" class="form-label">Default Role for New Users</label>
                <input type="text" class="form-control" id="defaultRole" name="defaultRole" [(ngModel)]="editableSettings.defaultRole">
                <!-- TODO: Consider a dropdown for roles -->
              </div>
              <!-- Add other users-permissions settings fields here -->
            </div>

            <!-- Appearance Settings -->
            <div *ngIf="currentCategory === 'appearance'">
              <div class="mb-3">
                <label for="themeColor" class="form-label">Theme Color</label>
                <input type="color" class="form-control form-control-color" id="themeColor" name="themeColor" [(ngModel)]="editableSettings.themeColor" title="Choose your color">
              </div>
              <div class="mb-3">
                <label for="logoUrl" class="form-label">Logo URL (Optional)</label>
                <input type="url" class="form-control" id="logoUrl" name="logoUrl" [(ngModel)]="editableSettings.logoUrl">
              </div>
              <!-- Add other appearance settings fields here -->
            </div>

            <!-- Integrations Settings -->
            <div *ngIf="currentCategory === 'integrations'">
              <div class="mb-3">
                <label for="googleAnalyticsId" class="form-label">Google Analytics ID (Optional)</label>
                <input type="text" class="form-control" id="googleAnalyticsId" name="googleAnalyticsId" [(ngModel)]="editableSettings.googleAnalyticsId">
              </div>
              <div class="mb-3">
                <label for="facebookPixelId" class="form-label">Facebook Pixel ID (Optional)</label>
                <input type="text" class="form-control" id="facebookPixelId" name="facebookPixelId" [(ngModel)]="editableSettings.facebookPixelId">
              </div>
              <!-- Add other integrations settings fields here -->
            </div>

            <div class="mt-4">
              <button type="button" class="btn btn-primary me-2" (click)="saveChanges()" [disabled]="isSaving || isResetting">
                <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Save Changes
              </button>
              <button type="button" class="btn btn-outline-secondary" (click)="resetToDefaults()" [disabled]="isResetting || isSaving">
                <span *ngIf="isResetting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Reset to Defaults
              </button>
            </div>
          </form>
        </section>

        <section class="settings-section mt-5">
          <h2>Backup and Restore</h2>
          <p>Download a backup of all your store settings or restore settings from a previously downloaded backup file.</p>
          <div class="mt-3">
            <button type="button" class="btn btn-info me-2" (click)="downloadBackup()" [disabled]="isDownloadingBackup">
              <span *ngIf="isDownloadingBackup" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              Download Settings Backup
            </button>
            <input type="file" #backupFileInput style="display: none;" (change)="onBackupFileSelected($event)" accept=".json">
            <button type="button" class="btn btn-outline-info me-2" (click)="backupFileInput.click()" [disabled]="isRestoringBackup">
              Select Backup File
            </button>
            <button type="button" class="btn btn-warning" (click)="restoreBackup()" [disabled]="!selectedBackupFile || isRestoringBackup">
              <span *ngIf="isRestoringBackup" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              Restore from Backup
            </button>
            <span *ngIf="selectedBackupFile" class="ms-2 align-middle">Selected: <i>{{ selectedBackupFile.name }}</i></span>
          </div>
        </section>

      </ng-container>

      <ng-container *ngIf="!isLoading && !error && !settings && currentCategory">
        <p>No settings found for the '{{formatCategoryName(currentCategory)}}' category.</p>
      </ng-container>
      <ng-container *ngIf="!isLoading && !error && !currentCategory">
        <p>Select a category from the sidebar to view or edit settings.</p>
      </ng-container>

    </main>
  </div>
</div>