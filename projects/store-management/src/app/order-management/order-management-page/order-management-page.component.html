<!-- Order Management Page -->
<div class="order-management-container">
  <h1>{{ tKeys.SM_ORDER_MGMT_PAGE_TITLE | translate }}</h1>

  <!-- Action Bar -->
  <div class="action-bar d-flex justify-content-between align-items-center mb-3">
    <div class="status-filters">
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <a class="nav-link" [class.active]="selectedStatus === ''" (click)="onStatusFilterChange('')">{{ tKeys.SM_ORDER_MGMT_PAGE_FILTER_ALL | translate }}</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" [class.active]="selectedStatus === 'pending'"
            (click)="onStatusFilterChange('pending')">{{ tKeys.SM_ORDER_STATUS_PENDING | translate }}</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" [class.active]="selectedStatus === 'processing'"
            (click)="onStatusFilterChange('processing')">{{ tKeys.SM_ORDER_STATUS_PROCESSING | translate }}</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" [class.active]="selectedStatus === 'shipped'"
            (click)="onStatusFilterChange('shipped')">{{ tKeys.SM_ORDER_STATUS_SHIPPED | translate }}</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" [class.active]="selectedStatus === 'delivered'"
            (click)="onStatusFilterChange('delivered')">{{ tKeys.SM_ORDER_MGMT_PAGE_FILTER_DELIVERED | translate }}</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" [class.active]="selectedStatus === 'cancelled'"
            (click)="onStatusFilterChange('cancelled')">{{ tKeys.SM_ORDER_STATUS_CANCELLED | translate }}</a>
        </li>
      </ul>
    </div>
    <div class="date-range-search d-flex align-items-center">
      <select class="form-select me-2" [(ngModel)]="selectedDateRange" (ngModelChange)="onDateRangeChange($event)">
        <option value="">{{ tKeys.SM_ORDER_MGMT_PAGE_DATERANGE_ALL | translate }}</option>
        <option value="today">{{ tKeys.SM_ORDER_MGMT_PAGE_DATERANGE_TODAY | translate }}</option>
        <option value="yesterday">{{ tKeys.SM_ORDER_MGMT_PAGE_DATERANGE_YESTERDAY | translate }}</option>
        <option value="last7days">{{ tKeys.SM_ORDER_MGMT_PAGE_DATERANGE_LAST7DAYS | translate }}</option>
        <option value="last30days">{{ tKeys.SM_ORDER_MGMT_PAGE_DATERANGE_LAST30DAYS | translate }}</option>
        <option value="thisMonth">{{ tKeys.SM_ORDER_MGMT_PAGE_DATERANGE_THIS_MONTH | translate }}</option>
        <option value="lastMonth">{{ tKeys.SM_ORDER_MGMT_PAGE_DATERANGE_LAST_MONTH | translate }}</option>
        <!-- <option value="custom">Custom Range</option> TODO: Implement custom range picker -->
      </select>
      <!-- Placeholder for custom date range picker if 'custom' is selected -->
      <!-- <div *ngIf="selectedDateRange === 'custom'" class="d-flex">
        <input type="date" class="form-control me-1" placeholder="Start Date" [(ngModel)]="customStartDate" (ngModelChange)="onCustomDateChange()">
        <input type="date" class="form-control" placeholder="End Date" [(ngModel)]="customEndDate" (ngModelChange)="onCustomDateChange()">
      </div> -->
      <input type="text" class="form-control me-2" [placeholder]="tKeys.SM_ORDER_MGMT_PAGE_SEARCH_PLACEHOLDER | translate" [(ngModel)]="searchTerm"
        (ngModelChange)="onSearchTermChange(searchTerm)">
      <button class="btn btn-secondary" (click)="exportOrders()" [disabled]="isExporting">
        <span *ngIf="isExporting" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
        {{ isExporting ? (tKeys.SM_ORDER_MGMT_PAGE_EXPORT_BUTTON_EXPORTING | translate) : (tKeys.SM_ORDER_MGMT_PAGE_EXPORT_BUTTON_EXPORT | translate) }}
      </button>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="isLoading" class="text-center my-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">{{ tKeys.SM_ORDER_MGMT_PAGE_LOADING_ARIA_TEXT | translate }}</span>
    </div>
    <p>{{ tKeys.SM_ORDER_MGMT_PAGE_LOADING_ORDERS_TEXT | translate }}</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="alert alert-danger my-4" role="alert">
    {{ tKeys.SM_ORDER_MGMT_PAGE_ERROR_LOADING_ORDERS | translate: { message: error.message } }}
  </div>

  <!-- Orders Table -->
  <div *ngIf="!isLoading && !error" class="orders-table-container">
    <table class="table table-striped">
      <thead>
        <tr>
          <th (click)="sortOrders('orderNumber')"
            [class.sorted-asc]="sortColumn === 'orderNumber' && sortDirection === 'asc'"
            [class.sorted-desc]="sortColumn === 'orderNumber' && sortDirection === 'desc'">{{ tKeys.SM_ORDER_MGMT_PAGE_TABLE_HEADER_ORDER_ID | translate }} <span
              *ngIf="sortColumn === 'orderNumber'" class="sort-indicator">{{ sortDirection === 'asc' ? '▲' : '▼'
              }}</span></th>
          <th (click)="sortOrders('createdAt')"
            [class.sorted-asc]="sortColumn === 'createdAt' && sortDirection === 'asc'"
            [class.sorted-desc]="sortColumn === 'createdAt' && sortDirection === 'desc'">{{ tKeys.SM_ORDER_MGMT_PAGE_TABLE_HEADER_DATETIME | translate }} <span
              *ngIf="sortColumn === 'createdAt'" class="sort-indicator">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
          </th>
          <th>{{ tKeys.SM_ORDER_MGMT_PAGE_TABLE_HEADER_CUSTOMER | translate }}</th>
          <th>{{ tKeys.SM_ORDER_MGMT_PAGE_TABLE_HEADER_ITEMS | translate }}</th>
          <th (click)="sortOrders('totalAmount')"
            [class.sorted-asc]="sortColumn === 'totalAmount' && sortDirection === 'asc'"
            [class.sorted-desc]="sortColumn === 'totalAmount' && sortDirection === 'desc'">{{ tKeys.SM_ORDER_MGMT_PAGE_TABLE_HEADER_TOTAL | translate }} <span
              *ngIf="sortColumn === 'totalAmount'" class="sort-indicator">{{ sortDirection === 'asc' ? '▲' : '▼'
              }}</span></th>
          <th (click)="sortOrders('status')" [class.sorted-asc]="sortColumn === 'status' && sortDirection === 'asc'"
            [class.sorted-desc]="sortColumn === 'status' && sortDirection === 'desc'">{{ tKeys.SM_ORDER_MGMT_PAGE_TABLE_HEADER_STATUS | translate }} <span
              *ngIf="sortColumn === 'status'" class="sort-indicator">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
          </th>
          <th>{{ tKeys.SM_ORDER_MGMT_PAGE_TABLE_HEADER_ACTIONS | translate }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngIf="orders.length === 0">
          <td colspan="7" class="text-center">{{ tKeys.SM_ORDER_MGMT_PAGE_NO_ORDERS_FOUND | translate }}</td>
        </tr>
        <tr *ngFor="let order of orders">
          <td>{{ order.orderNumber }}</td>
          <td>{{ order.createdAt | date: 'short' }}</td>
          <td>{{ order.customer?.firstName }} {{ order.customer?.lastName }}</td>
          <td>{{ order.items?.length || 0 }}</td>
          <td>{{ order.totalAmount | currency }}</td>
          <td>{{ getOrderStatusTranslationKey(order.status) | translate }}</td>
          <td>
            <button class="btn btn-sm btn-info me-1" (click)="openOrderDetailsModal(order)">{{ tKeys.SM_ORDER_MGMT_PAGE_ACTION_VIEW_DETAILS | translate }}</button>
            <button class="btn btn-sm btn-secondary" disabled>{{ tKeys.SM_ORDER_MGMT_PAGE_ACTION_UPDATE_STATUS | translate }}</button> <!-- Out of scope -->
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  <div *ngIf="!isLoading && !error && totalOrders > 0"
    class="pagination-controls d-flex justify-content-between align-items-center mt-3">
    <div class="orders-count-summary">
      <p>{{ paginationSummaryText }}</p> <!-- This is now a getter in the component that uses translateService -->
    </div>
    <div>
      <button class="btn btn-secondary me-1" [disabled]="currentPage === 1"
        (click)="onPageChange(currentPage - 1)">{{ tKeys.SM_ORDER_MGMT_PAGE_PAGINATION_PREVIOUS | translate }}</button>
      <span>{{ tKeys.SM_ORDER_MGMT_PAGE_PAGINATION_PAGE_INFO | translate: { currentPage: currentPage, totalPages: totalPages } }}</span>
      <button class="btn btn-secondary ms-1" [disabled]="currentPage === totalPages"
        (click)="onPageChange(currentPage + 1)">{{ tKeys.SM_ORDER_MGMT_PAGE_PAGINATION_NEXT | translate }}</button>
    </div>
  </div>

  <!-- Order Details Modal -->
  <app-order-details-modal [order]="selectedOrder" *ngIf="selectedOrder"></app-order-details-modal>
</div>